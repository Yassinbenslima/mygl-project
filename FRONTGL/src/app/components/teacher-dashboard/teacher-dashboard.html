<!-- Teacher Dashboard with Navbar -->
<app-navbar></app-navbar>

<!-- Modern Teacher Dashboard Header -->
<div class="dashboard-container">
<div class="dashboard-header">
    <div class="header-background">
      <div class="bg-gradient"></div>
      <div class="bg-pattern"></div>
    </div>
    
      <div class="header-content">
      <div class="teacher-profile-section"> 
        <div class="avatar-wrapper">
            <div class="teacher-avatar">
            <span class="avatar-initials">{{ getInitials() }}</span>
          </div>
          <div class="status-badge">
            <span class="status-dot"></span>
          </div>
        </div>
        
        <div class="teacher-info">
          <h1 class="teacher-name">
            {{ teacherDisplayName }}
            <mat-icon class="verified-icon">verified</mat-icon>
          </h1>
          <div class="teacher-meta">
            <span class="teacher-role-badge">
              <mat-icon>school</mat-icon>
              {{ teacherRole }}
            </span>
            <span class="teacher-dept-badge">
              <mat-icon>business</mat-icon>
              {{ teacherDepartment }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="quick-stats-grid">
        <div class="stat-card glass-effect">
          <div class="stat-icon-wrapper sessions-today">
            <mat-icon>event_available</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ teacher?.currentWeeklySessions || 0 }}</div>
            <div class="stat-label">Séances cette semaine</div>
          </div>
        </div>
        
        <div class="stat-card glass-effect">
          <div class="stat-icon-wrapper max-capacity">
            <mat-icon>assignment</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ teacher?.maxSessionsPerWeek || 0 }}</div>
            <div class="stat-label">Maximum autorisé</div>
          </div>
        </div>
        
        <div class="stat-card glass-effect">
          <div class="stat-icon-wrapper utilization">
            <mat-icon>insights</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ weeklyUtilization | number:'1.0-0' }}%</div>
            <div class="stat-label">Taux d'utilisation</div>
          </div>
        </div>
      </div>
    </div>
</div>

  <!-- Weekly Utilization Card -->
  <div class="utilization-card-modern">
    <div class="utilization-header">
      <div class="header-text">
        <mat-icon class="header-icon">trending_up</mat-icon>
        <div>
          <h3>Charge hebdomadaire</h3>
          <p>{{ teacher?.currentWeeklySessions || 0 }} / {{ teacher?.maxSessionsPerWeek || 0 }} séances</p>
        </div>
      </div>
      <div class="utilization-badge" [ngClass]="getUtilizationClass()">
        <span>{{ weeklyUtilization | number:'1.0-0' }}%</span>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar-wrapper">
        <div class="progress-bar-fill" [style.width.%]="weeklyUtilization" [ngClass]="getUtilizationClass()"></div>
      </div>
    </div>
    
    <div class="utilization-footer">
      <div class="status-message" [ngClass]="getUtilizationClass()">
        <mat-icon>{{ getStatusIcon() }}</mat-icon>
        <span>{{ getStatusMessage() }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Main Dashboard Content -->
<div class="dashboard-content">
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="modern-tabs">
    
    <!-- Calendar Tab -->
    <mat-tab>
      <ng-template matTabLabel>
        <div class="tab-label-content">
          <mat-icon>event</mat-icon>
          <span>Calendrier</span>
        </div>
      </ng-template>
      <ng-template matTabContent>
        <div class="tab-content-modern">
          
          <!-- Selected Date Séances Cards -->
          <div *ngIf="selectedDate && selectedDateSessions.length > 0" class="selected-date-sessions">
            <div class="selected-date-header">
              <div class="date-info">
                <mat-icon class="date-icon">event</mat-icon>
                <div>
                  <h3>{{ formatDate(selectedDate) }}</h3>
                  <p>{{ selectedDateSessions.length }} séance(s) disponible(s)</p>
                </div>
              </div>
            </div>
            
            <div class="sessions-grid">
              <div *ngFor="let session of selectedDateSessions" class="session-card-modern">
                <div class="session-card-header">
                  <div class="session-time-badge">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ session.startTime }} - {{ session.endTime }}</span>
                  </div>
                  <div class="session-status-badge" [ngClass]="'status-' + session.status.toLowerCase()">
                    <mat-icon>{{ getStatusIconForSession(session) }}</mat-icon>
                    <span>{{ session.status }}</span>
                  </div>
                </div>
                
                <div class="session-card-body">
                  <h4 class="session-subject">{{ session.subject }}</h4>
                  <div class="session-details">
                    <div class="detail-item">
                      <mat-icon>school</mat-icon>
                      <span>{{ session.grade.name }}</span>
                    </div>
                    <div class="detail-item">
                      <mat-icon>location_on</mat-icon>
                      <span>{{ session.location }}</span>
                    </div>
                    <div class="detail-item">
                      <mat-icon>people</mat-icon>
                      <span>{{ session.currentSupervisors }}/{{ session.requiredSupervisors }} surveillants</span>
                    </div>
                  </div>
                </div>
                
                <div class="session-card-footer">
                  <button mat-raised-button 
                          color="primary" 
                          class="confirm-button"
                          [disabled]="!session.available || session.status === 'FULL'"
                          (click)="confirmPreference(session)">
                    <mat-icon>check_circle</mat-icon>
                    Confirmer vœux
                  </button>
                  <button mat-icon-button 
                          class="info-button"
                          (click)="viewSessionDetails(session)"
                          matTooltip="Voir détails">
                    <mat-icon>info</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State when no sessions -->
          <div *ngIf="selectedDate && selectedDateSessions.length === 0" class="empty-date-state">
            <mat-icon>event_busy</mat-icon>
            <h3>Aucune séance disponible</h3>
            <p>Il n'y a pas de séances programmées pour cette date.</p>
          </div>

          <!-- Calendar -->
          <div class="card-modern glass-effect">
            <div class="card-header-modern">
              <div class="header-left">
                <div class="icon-circle primary">
                <mat-icon>event</mat-icon>
                </div>
                <div>
                  <h2>Calendrier des séances</h2>
                  <p>Sélectionnez une date pour voir les séances disponibles</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <app-calendar></app-calendar>
            </div>
          </div>
        </div>
      </ng-template>
    </mat-tab>

    <!-- Preferences Tab -->
    <mat-tab>
      <ng-template matTabLabel>
        <div class="tab-label-content">
          <mat-icon>favorite</mat-icon>
          <span>Mes Vœux</span>
        </div>
      </ng-template>
      <ng-template matTabContent>
        <div class="tab-content-modern">
          
          <!-- Selected Sessions Form -->
          <div *ngIf="hasSelectedSessions" class="card-modern glass-effect preferences-form-card">
            <div class="card-header-modern">
              <div class="header-left">
                <div class="icon-circle success">
                <mat-icon>assignment_turned_in</mat-icon>
                </div>
                <div>
                  <h2>Soumettre mes vœux</h2>
                  <p>Définissez les priorités pour vos séances sélectionnées</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <form [formGroup]="preferencesForm" (ngSubmit)="submitPreferences()">
                <div formArrayName="preferences">
                  <div *ngFor="let preference of preferencesFormArray.controls; let i = index" 
                       [formGroupName]="i" 
                       class="preference-item">
                    <mat-expansion-panel class="preference-panel">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <span class="priority-badge">{{ i + 1 }}</span>
                          {{ preference.get('sessionInfo')?.value }}
                        </mat-panel-title>
                        <mat-panel-description>
                          Priorité: {{ preference.get('priority')?.value }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>
                      
                      <div class="preference-content">
                        <mat-form-field appearance="outline" class="priority-field">
                          <mat-label>Priorité</mat-label>
                          <mat-select formControlName="priority">
                            <mat-option [value]="1">1 - Très prioritaire</mat-option>
                            <mat-option [value]="2">2 - Prioritaire</mat-option>
                            <mat-option [value]="3">3 - Normal</mat-option>
                            <mat-option [value]="4">4 - Peu prioritaire</mat-option>
                            <mat-option [value]="5">5 - Non prioritaire</mat-option>
                          </mat-select>
                        </mat-form-field>
                        
                        <button mat-icon-button 
                                type="button"
                                (click)="removeSessionFromSelection(selectedSessions[i])"
                                color="warn"
                                matTooltip="Retirer de la sélection">
                          <mat-icon>remove_circle</mat-icon>
                        </button>
                      </div>
                    </mat-expansion-panel>
                  </div>
                </div>
                
                <div class="form-actions">
                  <button mat-raised-button 
                          type="submit" 
                          color="primary"
                          [disabled]="!canSubmitPreferences || isSubmittingPreferences">
                    <mat-icon>send</mat-icon>
                    <span *ngIf="!isSubmittingPreferences">Soumettre les vœux</span>
                    <span *ngIf="isSubmittingPreferences">Soumission en cours...</span>
                  </button>
                  <button mat-button 
                          type="button"
                          (click)="clearCalendarSelection()">
                    Effacer la sélection
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Current Preferences -->
          <div class="card-modern glass-effect current-preferences-card">
            <div class="card-header-modern">
              <div class="header-left">
                <div class="icon-circle info">
                <mat-icon>list_alt</mat-icon>
                </div>
                <div>
                  <h2>Mes préférences actuelles</h2>
                  <p>Historique de vos vœux soumis</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div *ngIf="preferences.length === 0" class="no-preferences">
                <mat-icon>inbox</mat-icon>
                <p>Aucune préférence soumise</p>
              </div>
              
              <div *ngIf="preferences.length > 0" class="preferences-list">
                <div *ngFor="let preference of preferences" class="preference-item">
                  <div class="preference-info">
                    <div class="session-details">
                      <span class="session-name">Séance ID: {{ preference.sessionId }}</span>
                      <span class="priority">Priorité: {{ preference.priority }}</span>
                    </div>
                    <div class="status-info">
                      <mat-chip [ngClass]="'status-' + preference.status.toLowerCase()">
                        {{ getPreferenceStatusText(preference.status) }}
                      </mat-chip>
                    </div>
                  </div>
                  <div class="preference-actions">
                    <button mat-icon-button 
                            (click)="removePreference(preference)"
                            color="warn"
                            matTooltip="Supprimer cette préférence">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="preferences-actions" *ngIf="preferences.length > 0">
                <button mat-button (click)="printPreferences()">
                  <mat-icon>print</mat-icon>
                  Imprimer
                </button>
                <button mat-button (click)="exportPreferences()">
                  <mat-icon>download</mat-icon>
                  Exporter
                </button>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </mat-tab>

    <!-- Upcoming Sessions Tab -->
    <mat-tab>
      <ng-template matTabLabel>
        <div class="tab-label-content">
          <mat-icon>schedule</mat-icon>
          <span>Séances à venir</span>
        </div>
      </ng-template>
      <ng-template matTabContent>
        <div class="tab-content-modern">
          <div class="card-modern glass-effect upcoming-sessions-card">
            <div class="card-header-modern">
              <div class="header-left">
                <div class="icon-circle warning">
                <mat-icon>schedule</mat-icon>
                </div>
                <div>
                  <h2>Mes prochaines séances</h2>
                  <p>Séances de surveillance assignées</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div *ngIf="upcomingSessions.length === 0" class="no-sessions">
                <mat-icon>event_available</mat-icon>
                <p>Aucune séance assignée</p>
              </div>
              
              <div *ngIf="upcomingSessions.length > 0" class="sessions-table">
                <table mat-table [dataSource]="upcomingSessions" class="sessions-table-content">
                  <ng-container matColumnDef="subject">
                    <th mat-header-cell *matHeaderCellDef>Matière</th>
                    <td mat-cell *matCellDef="let session">{{ session.subject }}</td>
                  </ng-container>

                  <ng-container matColumnDef="grade">
                    <th mat-header-cell *matHeaderCellDef>Classe</th>
                    <td mat-cell *matCellDef="let session">{{ session.grade.name }}</td>
                  </ng-container>

                  <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let session">{{ session.date | date:'dd/MM/yyyy' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="time">
                    <th mat-header-cell *matHeaderCellDef>Heure</th>
                    <td mat-cell *matCellDef="let session">{{ session.startTime }} - {{ session.endTime }}</td>
                  </ng-container>

                  <ng-container matColumnDef="location">
                    <th mat-header-cell *matHeaderCellDef>Lieu</th>
                    <td mat-cell *matCellDef="let session">{{ session.location }}</td>
                  </ng-container>

                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Statut</th>
                    <td mat-cell *matCellDef="let session">
                      <mat-chip [ngClass]="'status-' + session.status.toLowerCase()">
                        {{ session.status }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let session">
                      <button mat-icon-button 
                              (click)="viewSessionDetails(session)"
                              matTooltip="Voir les détails">
                        <mat-icon>visibility</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </mat-tab>

  </mat-tab-group>
</div>
